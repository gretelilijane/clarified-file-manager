# ASVS Security Testing

## Selected ASVS points

[cols="1,1,1,1", options="header"]
|===
| Type | ID | Description | Reasoning

| Session Management
| 3.3.4
| Verify that users are able to view and (having re-entered login credentials) log out of any or all currently active sessions and devices.
| I did not check this before, and I wish to check it now.

| Server-Side Attacks
| 5.3.4
| Verify that data selection or database queries (e.g., SQL, HQL, ORM, NoSQL) use parameterized queries, ORMs, entity frameworks, or are otherwise protected from database injection attacks. 
| I was unsure which option to choose.

| XSS
| 12.5.2
| Verify that direct requests to uploaded files will never be executed as HTML/JavaScript content.
| While this is not possible with the current application (users can upload/download any type of file, but it is not executed by the browser), I would like to think through how to make it safer when using it in a different application or webpage.

| REST/API
| 13.2.3
| Verify that RESTful web services that utilize cookies are protected from Cross-Site Request Forgery via the use of at least one or more of the following: double submit cookie pattern, CSRF nonces, or Origin request header checks.
| I did not check this before, and I wish to check it now.

| File Management
| 12.4.2
| Verify that files obtained from untrusted sources are scanned by antivirus scanners to prevent the upload and serving of known malicious content.
| While I already know that this has not been implemented, and it is fairly easy to test, I am more interested in thinking through how to implement it on the webpage.

|===

## Tests

### https://asvs.dev/v4.0.3/0x12-V3-Session-management/#v32-session-binding[3.3.4] Session Management
Verify that users are able to view and (having re-entered login credentials) log out of any or all currently active sessions and devices.

#### Adaption

Application does not have a feature to view currently active sessions, therefore this part of the verification will be omitted.

"Verify that users are able to log out of all currently active sessions and devices."

#### Verification Methodology

Verification by active testing.

#### Prerequisites

. User has a valid account and is logged in to the webpage.

#### Procedure

. Log out from the webpage by sending a GET request to the ```http://localhost:8070/logout``` page.
. Use Session cookie from HTTP request header and set it as a session cookie in the browser.
. Navigate to the ```http://localhost:8070/files``` page.

#### Expected behaviour

The user is logged out and redirected to the login page.

#### Result(s)

The user is incorrectly logged in and authenticated, allowing them to perform all user actions.

#### Explanation

Terminating a session does not invalidate the session token, which remains valid until its MaxValue expiration time.

#### Threat analysis

If a malicious actor gains access to the session token, they can continue using the session even after the user has logged out, until the session token expires (MaxValue).

The malicious actor can perform the following actions:

. View the list of all files uploaded by the user.
. Download any file from the user's account.
. Upload new files to the user's account.
. Delete any file from the user's account.

#### Recommendations

Store the last logout time in the database and include the login time in the session cookie. If the login time is earlier than the logout time, discard any requests associated with this session token.

### https://asvs.dev/v4.0.3/0x13-V5-Validation-Sanitization-Encoding/[5.3.4] Server-Side Attacks
Verify that data selection or database queries (e.g., SQL, HQL, ORM, NoSQL) use parameterized queries, ORMs, entity frameworks, or are otherwise protected from database injection attacks.

#### Adaption

No adaptation needed.

#### Verification Methodology

Verification by code inspection. (Could also be verified by active testing.)

#### Prerequisites

. Access to the source code.

#### Procedure

. Identify all places where data selection or database queries are used.
. Verify that the queries are using parameterized queries, ORMs, entity frameworks, or are otherwise protected from database injection attacks.

#### Expected behaviour

All database queries are protected from SQL injection attacks.

#### Result(s)

. Database query that writes username, password hash and salt to the DB is in the https://github.com/gretelilijane/clarified-file-manager/blob/6be396ffc32207eaa6a68be30a89bb620821f126/handlers/signUpPageHandler.go#L51[signupPageHandler]. This query is using Exec method which is parametrized. *This query is protected from SQL injection attacks.*
. Database query that retrives user login data from the DB is in the https://github.com/gretelilijane/clarified-file-manager/blob/6be396ffc32207eaa6a68be30a89bb620821f126/handlers/logInPageHandler.go#L38[logInPageHandler]. This query is using QueryRow which is parametrized. *This query is protected from SQL injection attacks.*
. Database query that retrives uploaded data in the user selected order is in the https://github.com/gretelilijane/clarified-file-manager/blob/6be396ffc32207eaa6a68be30a89bb620821f126/handlers/filesPageHandler%20.go#L26[filesPageHandler]. This query is partially parametrized. User ID is parametrized, but the order and sort directions are not. Order and sort directions are checked against a list of allowed values. If the value is not in the list, the default value is used. *This query is protected from SQL injection attacks.*
. Database query that deletes a file from the DB is in the https://github.com/gretelilijane/clarified-file-manager/blob/6be396ffc32207eaa6a68be30a89bb620821f126/handlers/deleteFileHandler.go#L24[deleteFileHandler]. This query is using Exec method which is parametrized. *This query is protected from SQL injection attacks.*
. Database query that uploads a file to the DB is in the https://github.com/gretelilijane/clarified-file-manager/blob/6be396ffc32207eaa6a68be30a89bb620821f126/handlers/uploadHandler.go#L80[uploadHandler]. This query is using QueryRow method which is parametrized. *This query is protected from SQL injection attacks.*
. Database query that downloads a file from the DB is in the https://github.com/gretelilijane/clarified-file-manager/blob/6be396ffc32207eaa6a68be30a89bb620821f126/handlers/downloadFileHandler.go#L30[downloadFileHandler]. This query is using QueryRow method which is parametrized. *This query is protected from SQL injection attacks.*

#### Explanation

Parameterized queries protect against SQL injection by ensuring that user input is treated strictly as data, not as part of the SQL query itself. This prevents malicious users from manipulating the SQL query structure to execute unintended commands.

#### Threat analysis

This application is not vulnerable to SQL injection attacks.

#### Recommendations

N/A


### 13.2.3

Verify that RESTful web services that utilize cookies are protected from Cross-Site Request Forgery via the use of at least one or more of the following: double submit cookie pattern, CSRF nonces, or Origin request header checks.