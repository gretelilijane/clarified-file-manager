# ASVS Security Testing

## Selected ASVS points

[cols="1,1,1,1", options="header"]
|===
| Type | ID | Description | Reasoning

| Session Management
| 3.3.4
| Verify that users are able to view and (having re-entered login credentials) log out of any or all currently active sessions and devices.
| I did not check this before, and I wish to check it now.

| Server-Side Attacks
| 5.3.4
| Verify that data selection or database queries (e.g., SQL, HQL, ORM, NoSQL) use parameterized queries, ORMs, entity frameworks, or are otherwise protected from database injection attacks. 
| I was unsure which option to choose.

| XSS
| 12.5.2
| Verify that direct requests to uploaded files will never be executed as HTML/JavaScript content.
| While this is not possible with the current application (users can upload/download any type of file, but it is not executed by the browser), I would like to think through how to make it safer when using it in a different application or webpage.

| REST/API
| 13.2.3
| Verify that RESTful web services that utilize cookies are protected from Cross-Site Request Forgery via the use of at least one or more of the following: double submit cookie pattern, CSRF nonces, or Origin request header checks.
| I did not check this before, and I wish to check it now.

| File Management
| 12.4.2
| Verify that files obtained from untrusted sources are scanned by antivirus scanners to prevent the upload and serving of known malicious content.
| While I already know that this has not been implemented, and it is fairly easy to test, I am more interested in thinking through how to implement it on the webpage.

|===

## Tests

All test were performed with Google Chrome browser Version 128.0.6613.119 (Official Build) (64-bit) and with  Mozilla Firefox 133.0 browser.


### https://asvs.dev/v4.0.3/0x12-V3-Session-management/#v33-session-termination[3.3.4] Session Management

Verify that users are able to view and (having re-entered login credentials) log out of any or all currently active sessions and devices.

#### Adaption

Application does not have a feature to view currently active sessions, therefore this part of the verification will be omitted.

"Verify that users are able to log out of all currently active sessions and devices."

#### Verification Methodology

Verification by active testing.

#### Prerequisites

. User has a valid account and is logged in to the webpage.

#### Procedure

. Log in to the webpage in browser 1.
. Open the webpage in another browser and log in with the same credentials in browser 2.
. Save the session cookie from the browser 1.
. Log out from browser 1 session by sending a GET request to the ```http://localhost:8070/logout``` page.
. Use Session cookie from browser 1 and set it as a session cookie in  browser 2.
. In browser 2, navigate to the ```http://localhost:8070/files``` page.

#### Expected behaviour

The user is logged out and redirected to the login page.

#### Result(s)

The user is incorrectly logged in and authenticated, allowing them to perform all user actions.

#### Explanation

Terminating a session does not invalidate the session token, which remains valid until its MaxValue expiration time.

#### Threat analysis

If a malicious actor gains access to the session token, they can continue using the session even after the user has logged out, until the session token expires (MaxValue).

The malicious actor can perform the following actions:

. View the list of all files uploaded by the user.
. Download any file from the user's account.
. Upload new files to the user's account.
. Delete any file from the user's account.

#### Recommendations

Store the last logout time in the database and include the login time in the session cookie. If the login time is earlier than the logout time, discard any requests associated with this session token.

### https://asvs.dev/v4.0.3/0x13-V5-Validation-Sanitization-Encoding/#v53-output-encoding-and-injection-prevention[5.3.4] Server-Side Attacks

Verify that data selection or database queries (e.g., SQL, HQL, ORM, NoSQL) use parameterized queries, ORMs, entity frameworks, or are otherwise protected from database injection attacks.

#### Adaption

No adaptation needed.

#### Verification Methodology

Verification by code inspection. (Could also be verified by active testing.)

#### Prerequisites

. Access to the source code.

#### Procedure

. Identify all places where data selection or database queries are used.
. Verify that the queries are using parameterized queries, ORMs, entity frameworks, or are otherwise protected from database injection attacks.

#### Expected behaviour

All database queries are protected from SQL injection attacks.

#### Result(s)

. Database query that writes username, password hash and salt to the DB is in the https://github.com/gretelilijane/clarified-file-manager/blob/6be396ffc32207eaa6a68be30a89bb620821f126/handlers/signUpPageHandler.go#L51[signupPageHandler]. This query is using Exec method which is parametrized. *This query is protected from SQL injection attacks.*
. Database query that retrives user login data from the DB is in the https://github.com/gretelilijane/clarified-file-manager/blob/6be396ffc32207eaa6a68be30a89bb620821f126/handlers/logInPageHandler.go#L38[logInPageHandler]. This query is using QueryRow which is parametrized. *This query is protected from SQL injection attacks.*
. Database query that retrives uploaded data in the user selected order is in the https://github.com/gretelilijane/clarified-file-manager/blob/6be396ffc32207eaa6a68be30a89bb620821f126/handlers/filesPageHandler%20.go#L26[filesPageHandler]. This query is partially parametrized. User ID is parametrized, but the order and sort directions are not. Order and sort directions are checked against a list of allowed values. If the value is not in the list, the default value is used. *This query is protected from SQL injection attacks.*
. Database query that deletes a file from the DB is in the https://github.com/gretelilijane/clarified-file-manager/blob/6be396ffc32207eaa6a68be30a89bb620821f126/handlers/deleteFileHandler.go#L24[deleteFileHandler]. This query is using Exec method which is parametrized. *This query is protected from SQL injection attacks.*
. Database query that uploads a file to the DB is in the https://github.com/gretelilijane/clarified-file-manager/blob/6be396ffc32207eaa6a68be30a89bb620821f126/handlers/uploadHandler.go#L80[uploadHandler]. This query is using QueryRow method which is parametrized. *This query is protected from SQL injection attacks.*
. Database query that downloads a file from the DB is in the https://github.com/gretelilijane/clarified-file-manager/blob/6be396ffc32207eaa6a68be30a89bb620821f126/handlers/downloadFileHandler.go#L30[downloadFileHandler]. This query is using QueryRow method which is parametrized. *This query is protected from SQL injection attacks.*

#### Explanation

Parameterized queries protect against SQL injection by ensuring that user input is treated strictly as data, not as part of the SQL query itself. This prevents malicious users from manipulating the SQL query structure to execute unintended commands.

#### Threat analysis

This application is not vulnerable to SQL injection attacks.

#### Recommendations

N/A

### https://asvs.dev/v4.0.3/0x20-V12-Files-Resources/#v125-file-download[12.5.2] XSS

Verify that direct requests to uploaded files will never be executed as HTML/JavaScript content.

#### Adaption

No adaptation needed.

#### Verification Methodology

Verification by code inspectionand and by testing.

#### Prerequisites

. Access to the source code.
. Access to the webpage.

#### Procedure

. Log in to the webpage.
. Create three files with content 
```html
<script>
  alert('This is executed!');
</script>
```
name one file `test.html`, the other `test.txt` and the third `test`.
. Upload all files to the webpage.
. Download all files from the webpage.
. Inspect if alert message was executed.

#### Expected behaviour

Only direct request made to the uploaded files is downloading the files.
None of the files should execute the JavaScript code when downloaded.

#### Result(s)

None of the files executed the JavaScript code.

#### Explanation

https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Disposition[Content-Disposition] header is set to attachment, which forces the browser to download the file instead of displayed inline and executing it.
https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type[Content-Type] header makes sure that in case the Content-Disposition header is unset, the browser will not execute the files with incorrect extensions (test and test.txt) as HTML/JavaScript.

#### Threat analysis

##### MIME sniffing

Some browsers may perform MIME sniffing and ignore the Content-Type header if the `X-Content-Type-Options: nosniff` header is not set. If nosniff is not set, the browser may sniff the content of the files and treat files `test` and `test.txt` as HTML/JavaScript, potentially executing malicious script.

#### Recommendations

. Whitelist allowed MIME types.
. Discard files with unexpected file content.
. Set `X-Content-Type-Options: nosniff` header. 
. Scan file content with antivirus scanner before uploading it to the server.

### https://asvs.dev/v4.0.3/0x21-V13-API/#v132-restful-web-service[13.2.3] REST/API

Verify that RESTful web services that utilize cookies are protected from Cross-Site Request Forgery via the use of at least one or more of the following: double submit cookie pattern, CSRF nonces, or Origin request header checks.

#### Adaption/Scope

The scope of the test is to veryfy that the DELETE request is protected from CSRF attacks.

#### Verification Methodology

Verification by testing.

#### Prerequisites

. Access to the webpage.

#### Procedure

. Log in to the webpage.
. Upload a file to the webpage.
. Check uploaded file ID using browser developer tools or by hovering with mouse over download button.
. Serve file CSRF_delete.html to browser
.. Set the correct id for DELETE request in ./docs/CSRF_delete.html line 10.
.. cd /docs && python3 -m http.server 8000
.. Navigate to http://{server_host}:8000/CSRF_delete.html
.. Click on the button to delete the file.

#### Expected behaviour

DELETE request is protected from CSRF attacks.

#### Result(s)

DELETE request is protected from CSRF attacks.

#### Explanation

When doing CORS requests, server makes preflight request to check if the request is allowed. If the request is not allowed, the server will respond with 405 Method Not Allowed.

#### Threat analysis

Nothing to report here.

#### Recommendations

. Set `Access-Control-Allow-*` headers explicitly in the code for clarity.